#!/usr/bin/env node

var path = require('path');
var grunt = require('grunt');
var commander = require('commander');
var color = require('colorful').color;
var manage = require('../lib/manage');
var helper = require('../lib/helper');
var initDir = helper.initDir;

/*
  available templates
*/

helper.mkdirp(initDir);

var templates = helper.availableTemplates(initDir);

/*
  commander init
*/

commander
  .version(require('../package.json').version)
  .usage('[template]')
  .option('-d, --debug', 'Enable debugging mode for tasks that support it.')
  .option('-v, --verbose', 'Show more infomation.')
  .option('--stack', 'Show stack message.')
  .option('--install <template>', 'Install specified template.')
  .option('--upgrade <template>', 'Update specified template.')
  .option('--update', 'Get index from web.')
  .option('--list', 'Show templates from index.');

commander.on('--help', function() {
  console.log();
  console.log(color.cyan('  Available templates:'));
  console.log();
  if (!helper.isEmptyObject(templates)) {
    helper.writeTable(templates);
  } else {
    console.log('    No templates found');
  }
  console.log();
  console.log('  Change init directory in ~/.spm/spmrc');
  console.log();
  console.log(color.magenta('    [init]'));
  console.log('    template = ~/.spm/init');
  console.log();
});
commander.parse(process.argv);

/*
  show help
*/

var cmd = commander.args[0];
if (!cmd || !templates[cmd]) {
  // argu not exist
  if (cmd) {
    console.log();
    console.log(color.red('  Template "' + cmd + '" not exist.'));
  }
  // no argu
  process.stdout.write(commander.helpInformation());
  commander.emit('--help');
  process.exit();
}

/*
  manage template
*/

manage(commander) || process.exit();

/*
  run grunt init task
*/

var gruntOption = {};
if (commander.stack) gruntOption.stack = true;

grunt.task.loadTasks(path.join(__dirname, '../node_modules/grunt-init/tasks'));
// fix windows directory by replace C:\ to C\:\
grunt.cli.tasks = ['init:' + templates[cmd].directory.replace(/^([a-zA-Z]):\\/, '$1\\:\\')];
grunt.cli(gruntOption);
